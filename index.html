<!DOCTYPE html>
<html>
<head>
    <title>btc names (aka xns)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        * {font-family: 'VT323', monospace; text-align:center}
        body {width:60%; margin:0 auto; font-size: 1.5rem;}
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            margin: 0 auto;
        }
        th, td {
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1>btc names (aka xns)</h1>
    <table id="result"></table>

    <script>
        const API_URL = 'https://xchain.io/api/issuances/';
        const DISPENSER_API_URL = 'https://xchain.io/api/dispensers/';
        const ASSET_URL = 'http://xchain.io/asset/';
        const DISPENSER_URL = 'http://xchain.io/tx';
        const MAX_RESULTS = 1;
        let currentResults = 0;

        async function fetchIssuancesForBlock(blockNumber) {
            try {
                let response = await fetch(API_URL + blockNumber);
                let data = await response.json();
                return data;
            } catch(error) {
                console.error('Error:', error);
                return 'Error occurred. See console for details.';
            }
        }

        async function checkDispenser(assetName) {
            try {
                let response = await fetch(DISPENSER_API_URL + assetName);
                let data = await response.json();
                if(data.data.length > 0) {
                    // Return the first dispenser found
                    return data.data[0];
                } else {
                    // Return null if no dispensers found
                    return null;
                }
            } catch(error) {
                console.error('Error:', error);
                return 'Error occurred. See console for details.';
            }
        }

        async function processBlock(blockNumber) {
            let issuances = await fetchIssuancesForBlock(blockNumber);
            for(let issuance of issuances.data) {
                if (issuance.description.startsWith('name:')) {
                    // Increment result counter
                    currentResults++;
                    // Extract the name
                    let name = issuance.description.substring(5).trim();  // Remove 'name:' from the description
                    if (name.startsWith('U+')) {
                        // If it's a unicode, convert to actual character
                        let unicode = name.split('U+')[1];
                        name = String.fromCodePoint('0x' + unicode);
                    }
                    // Check dispenser for the asset
                    let dispenserData = await checkDispenser(issuance.asset);
                    // Add to table
                    let row = document.createElement('tr');
                    let numCell = document.createElement('td');
                    numCell.textContent = currentResults;
                    let nameCell = document.createElement('td');
                    nameCell.textContent = name;
                    let assetCell = document.createElement('td');
                    let link = document.createElement('a');
                    link.href = ASSET_URL + issuance.asset;
                    link.textContent = issuance.asset;
                    assetCell.appendChild(link);
                    let dispenserCell = document.createElement('td');
                    // If dispenser exists, add link to it
                    if (dispenserData !== null) {
                        let link = document.createElement('a');
                        link.href = `https://xchain.io/tx/${dispenserData.tx_hash}`;  // Create link to dispenser
                        link.textContent = `${dispenserData.give_remaining} @ ${dispenserData.satoshi_price}`;  // Display remaining and price
                        dispenserCell.appendChild(link);
                    } else {
                        dispenserCell.textContent = 'No Dispenser';
                    }
                    row.appendChild(numCell);
                    row.appendChild(nameCell);
                    row.appendChild(assetCell);
                    row.appendChild(dispenserCell);
                    document.getElementById('result').appendChild(row);
                }
            }
        }

        async function getIndexer() {
            let startBlock = 791681;
            let endBlock;

            let block = await fetch('https://blockchain.info/q/getblockcount');
            let blockText = await block.text();
            endBlock = parseInt(blockText);

            document.getElementById('result').innerHTML = `<tr><th>Number</th><th>Name</th><th>Asset Name</th><th>Dispenser</th></tr>`; // Clear the results
            currentResults = 0; // Reset results count

            let blockNumbers = [];
            for(let i = endBlock; i >= startBlock && blockNumbers.length < MAX_RESULTS; i--) {
                blockNumbers.push(i);
            }

            blockNumbers.sort((a, b) => a - b);  // This will sort the array in ascending order

            for(let blockNumber of blockNumbers) {
                await processBlock(blockNumber);
            }
        }

        window.onload = function() {
            getIndexer(); // Fetch data when the page loads
        };
  </script>
</body>
</html>
